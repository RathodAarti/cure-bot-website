# Database: Supabase Setup and Variables

This app can optionally store messages in Supabase in addition to localStorage.
If Supabase variables are not provided, the app continues to work with localStorage only.

## Environment variables
Create a `.env` (or `.env.local`) at the project root with:

```
VITE_SUPABASE_URL=your_project_url
VITE_SUPABASE_ANON_KEY=your_anon_key
```

## NPM dependency
Install the Supabase client:

```
npm i @supabase/supabase-js
```

## Schema
Run this SQL in the Supabase SQL editor to create the `messages` table:

```sql
create table if not exists messages (
  id bigint generated by default as identity primary key,
  role text not null check (role in ('user','assistant')),
  content text not null,
  sources jsonb default '[]'::jsonb,
  done boolean default true,
  ts bigint not null,
  created_at timestamptz default now()
);
```

You can extend this later with:

```sql
-- Optional: conversation threads
alter table messages add column if not exists conversation_id uuid;
create index if not exists messages_conversation_idx on messages(conversation_id);

-- Optional: feedback
create table if not exists feedback (
  id bigint generated by default as identity primary key,
  message_id bigint references messages(id) on delete cascade,
  value int not null,
  ts bigint not null,
  created_at timestamptz default now()
);
```

## Where variables are used
- `src/lib/supabase.js`: reads `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`, creates client lazily.
- `src/db/local.js`: `saveMessage()` cross-saves to Supabase via `saveMessageSupabase()` (best effort, non-blocking).
- `src/adapters/mock.js`: calls `saveMessage()` for both user and assistant messages, so they sync to Supabase when configured.

## How to verify
1. Start the dev server.
2. Send a message in chat.
3. In Supabase → Table Editor → `messages`, you should see new rows.

If you don’t see rows, check:
- `.env` values are correct and the dev server has been restarted.
- `@supabase/supabase-js` is installed.
- The `messages` table exists as above.
